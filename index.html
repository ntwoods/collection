<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Collection Portal</title>

<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
  :root{
    --bg:#f7fbff;
    --card:#fff;
    --blue:#2563eb;
    --chip:#eef6ff;
    --chipB:#cfe3ff;
    --muted:#64748b;
    --yellow:#fff6d6;
    --green:#e5ffe8;
  }

  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI;}

  body{
    margin:0;background:linear-gradient(180deg,#fff,var(--bg));color:#0f172a;
  }

  header{
    padding:16px 20px;border-bottom:1px solid #e6eefc;
    display:flex;gap:12px;align-items:center;
  }

  .badge{
    background:#e6f0ff;color:var(--blue);
    padding:4px 10px;border-radius:999px;font-weight:600
  }

  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #e6eefc;border-radius:16px;
    box-shadow:0 6px 18px rgba(37,99,235,.08);padding:18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}

  .chip{
    background:#fff;border:1px solid var(--chipB);
    border-radius:12px;padding:12px;cursor:pointer;
    transition:transform .08s,box-shadow .08s;
  }
  .chip:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(37,99,235,.12)}
  .chip.follow{background:#eaf3ff;border-color:#9ac2ff;outline:2px solid #bfd7ff}
  .chip.future-green{background:var(--green)}
  .chip.future-yellow{background:var(--yellow)}

  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .btn{
    border:1px solid #cfe3ff;background:#fff;color:#2563eb;
    padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer;
    transition:0.2s;
  }
  .btn.primary{
    background:#2563eb;color:#fff;border-color:#2563eb;
  }
  .btn:disabled{
    opacity:0.6;cursor:not-allowed;
  }

  /* modal */
  .back{
    position:fixed;inset:0;background:rgba(15,23,42,.45);
    display:none;align-items:center;justify-content:center;padding:16px;
  }
  .modal{
    background:#fff;border:1px solid #e6eefc;border-radius:16px;
    max-width:480px;width:100%;padding:18px;
  }

  input,select,textarea{
    padding:8px;border:1px solid #cfe3ff;border-radius:8px;width:100%;
  }

  /* Spinner */
  .spinner{
    border:3px solid #e6e6e6;
    border-top:3px solid #2563eb;
    border-radius:50%;
    width:16px;height:16px;
    animation:spin 0.8s linear infinite;
    display:inline-block;margin-right:8px;
    vertical-align:middle;
  }
  @keyframes spin{100%{transform:rotate(360deg)}}

</style>
</head>

<body>

<header>
  <h3 style="margin:0">Collection Follow-ups</h3>
  <span id="who" class="badge">Sign-in required</span>
  <span id="today" class="badge"></span>

  <div style="margin-left:auto" class="toolbar">
    <div id="gBtn"></div>
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn" id="btnClose">Force Close</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="toolbar">
      <span class="badge" id="count">0 items</span>
      <span id="countdown" style="color:#64748b"></span>
    </div>

    <!-- loader -->
    <div id="pageLoader" style="display:none;text-align:center;padding:30px">
      <div class="spinner"></div> Loading...
    </div>

    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- Modal -->
<div class="back" id="mBack">
  <div class="modal">

    <h3 id="mTitle" style="margin:0 0 12px 0">Action</h3>

    <!-- Action Buttons -->
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn" id="actDone">Done</button>
      <button class="btn" id="actWillPay">Will Pay After X Days</button>
      <button class="btn" id="actNotConn">Not Connected</button>
      <button class="btn" id="actLedger">Ledger Required</button>
      <button class="btn" id="mCancel" style="margin-left:auto">Cancel</button>
    </div>

    <!-- Dynamic Inputs -->
    <div id="secDays" style="display:none;margin-bottom:10px">
      <label style="font-size:13px;color:var(--muted)">No. of Days</label>
      <input type="number" id="inpDays" min="1" placeholder="Enter days"/>
    </div>

    <div id="secNC" style="display:none;margin-bottom:10px">
      <label style="font-size:13px;color:var(--muted)">Next Follow-up Date & Time</label>
      <input type="datetime-local" id="inpNCDate"/>
    </div>

    <div style="margin-bottom:10px">
      <label style="font-size:13px;color:var(--muted)">Remark (optional)</label>
      <textarea id="inpRemark" rows="3"></textarea>
    </div>

    <button class="btn primary" style="width:100%" id="submitFinal">
      Submit
    </button>

  </div>
</div>


<script>
/* ---------- CONFIG ---------- */
const API_URL   = "https://script.google.com/macros/s/AKfycbxUrOkj5uOyJCGnBe1g9KKg30dzgBB7PpR8lUsGPVSYtR2oeXvUMCYDy0uPmW5oPth_/exec";
const CLIENT_ID = "360849757137-agopfs0m8rgmcj541ucpg22btep5olt3.apps.googleusercontent.com";

/* ---------- STATE ---------- */
let idToken=null, userEmail=null, items=[], selected=null, pendingAction=null;

/* ---------- INIT ---------- */
window.onload = () => {
  google.accounts.id.initialize({
    client_id: CLIENT_ID,
    callback: handleCred
  });
  google.accounts.id.renderButton(document.getElementById("gBtn"), {
    theme:"outline", size:"large"
  });

  document.getElementById("btnRefresh").onclick = load;
  document.getElementById("btnClose").onclick   = closeNow;

  startCountdown();
};

/* ---------- LOGIN ---------- */
function handleCred(resp){
  idToken = resp.credential;
  const p = JSON.parse(atob(idToken.split('.')[1]));
  userEmail = p.email;

  document.getElementById("who").textContent = userEmail;
  load();
}

/* ---------- API ---------- */
async function api(action,payload){
  const r = await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({action,idToken,payload})
  });
  const j = await r.json();
  if(!j.ok) throw new Error(j.error);
  return j.data;
}

/* ---------- LOAD DASHBOARD ---------- */
async function load(){
  showPageLoader(true);

  const data = await api("getDashboard");

  items = data.items;
  showPageLoader(false);
  render();
}

/* loader */
function showPageLoader(st){
  document.getElementById("pageLoader").style.display = st ? "block":"none";
  document.getElementById("grid").style.display = st ? "none":"grid";
}

/* ---------- RENDER ---------- */
function render(){
  const g = document.getElementById("grid");
  g.innerHTML = "";

  items.forEach((it,idx)=>{
    const d = document.createElement("div");

    let cls = "chip";
    if(it.highlight) cls += " follow";
    if(it.futureGreen) cls += " future-green";
    if(it.futureYellow) cls += " future-yellow";

    d.className = cls;
    d.innerHTML = `
      <div style="font-weight:700">${sanitize(it.party)}</div>
      <div class="meta">${it.source ? it.source : "Today"}</div>
      ${it.dueDate ? `<div class="meta">Due: ${format(it.dueDate)}</div>` : ""}
    `;

    d.onclick = ()=> openModal(it,idx);
    g.appendChild(d);
  });

  document.getElementById("count").textContent = items.length+" items";
}

/* Helpers */
function sanitize(s){return(""+s).replace(/[&<>]/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[m]));}
function format(x){
  const d = new Date(x);
  return d.toLocaleString("en-IN",{day:"2-digit",month:"short",year:"numeric"});
}

/* ---------- MODAL ---------- */
function openModal(it,idx){
  selected = {it,idx};
  pendingAction = null;

  ["actDone","actWillPay","actNotConn","actLedger"].forEach(id=>{
    document.getElementById(id).classList.remove("primary");
  });

  document.getElementById("secDays").style.display="none";
  document.getElementById("secNC").style.display="none";

  document.getElementById("inpRemark").value="";
  document.getElementById("inpDays").value="";
  document.getElementById("inpNCDate").value="";

  document.getElementById("mTitle").textContent = it.party;
  document.getElementById("mBack").style.display="flex";

  document.getElementById("actDone").onclick      = ()=> choose("Done");
  document.getElementById("actWillPay").onclick   = ()=> choose("WillPay");
  document.getElementById("actNotConn").onclick   = ()=> choose("NotConnected");
  document.getElementById("actLedger").onclick    = ()=> choose("LedgerRequired");
  document.getElementById("mCancel").onclick      = closeModal;

  document.getElementById("submitFinal").onclick = submitFinal;
}

function choose(action){
  pendingAction = action;

  ["actDone","actWillPay","actNotConn","actLedger"].forEach(id=>{
    document.getElementById(id).classList.remove("primary");
  });

  if(action==="Done")         document.getElementById("actDone").classList.add("primary");
  if(action==="WillPay")      document.getElementById("actWillPay").classList.add("primary");
  if(action==="NotConnected") document.getElementById("actNotConn").classList.add("primary");
  if(action==="LedgerRequired") document.getElementById("actLedger").classList.add("primary");

  document.getElementById("secDays").style.display = (action==="WillPay" ? "block":"none");
  document.getElementById("secNC").style.display   = (action==="NotConnected" ? "block":"none");
}

function closeModal(){
  document.getElementById("mBack").style.display="none";
}

/* ---------- SUBMIT ---------- */
async function submitFinal(){
  if(!pendingAction) return alert("Please select any action.");

  const btn = document.getElementById("submitFinal");
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span>Processing...`;

  let payload = {
    source  : selected.it.source,
    rowIndex: selected.it.rowIndex,
    party   : selected.it.party,
    action  : pendingAction,
    remark  : document.getElementById("inpRemark").value.trim()
  };

  if(pendingAction==="WillPay"){
    const d = document.getElementById("inpDays").value;
    if(!d || d<1){
      btn.disabled=false; btn.innerHTML="Submit";
      return alert("Enter valid days!");
    }
    payload.days = d;
  }

  if(pendingAction==="NotConnected"){
    const dt = document.getElementById("inpNCDate").value;
    if(!dt){
      btn.disabled=false; btn.innerHTML="Submit";
      return alert("Select next follow-up date & time!");
    }
    payload.nextDateTime = dt;
  }

  await api("markAction",payload);

  // ✅ UI behaviour per action
  if (pendingAction === "NotConnected") {
    // Card ko remove nahi karna, bas follow-up card bana do
    const next = payload.nextDateTime;
    const dueISO = next ? new Date(next).toISOString() : null;

    selected.it.source    = "FollowUp";
    selected.it.highlight = true;
    selected.it.dueDate   = dueISO;

    items[selected.idx] = selected.it;  // update in place
  } else {
    // Done / WillPay / LedgerRequired → list se hata do
    items.splice(selected.idx,1);
  }

  render();
  closeModal();

  btn.disabled = false;
  btn.innerHTML = "Submit";
}

/* ---------- FORCE CLOSE ---------- */
async function closeNow(){
  if(!confirm("Force close remaining followups?")) return;
  await api("closeOutUser");
  load();
}

/* ---------- COUNTDOWN ---------- */
function startCountdown(){
  const el = document.getElementById("countdown");
  function tick(){
    const now=new Date();
    const tgt=new Date();
    tgt.setHours(19,0,0,0);

    if(now>tgt){ el.textContent="Closing completed"; return; }

    const ms=tgt-now;
    const h=Math.floor(ms/3600000),
          m=Math.floor((ms%3600000)/60000),
          s=Math.floor((ms%60000)/1000);

    el.textContent = `Auto close in ${h}:${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    setTimeout(tick,1000);
  }
  tick();
}
</script>

</body>
</html>
