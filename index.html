<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Follow-up Portal</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root{--bg:#f7fbff;--card:#fff;--blue:#2563eb;--blueSoft:#e6f0ff;--chip:#eef6ff;--chipB:#cfe3ff;--muted:#64748b}
  *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  body{margin:0;background:linear-gradient(180deg,#fff,var(--bg));color:#0f172a}
  header{padding:16px 20px;border-bottom:1px solid #e6eefc;display:flex;gap:12px;align-items:center}
  .badge{background:var(--blueSoft);color:var(--blue);padding:4px 10px;border-radius:999px;font-weight:600}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid #e6eefc;border-radius:16px;box-shadow:0 6px 18px rgba(37,99,235,.08);padding:18px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:12px}
  .chip{background:var(--chip);border:1px solid var(--chipB);border-radius:12px;padding:12px;cursor:pointer;transition:transform .08s,box-shadow .08s}
  .chip:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(37,99,235,.12)}
  .chip.follow{background:#eaf3ff;border-color:#9ac2ff;outline:2px solid #bfd7ff}
  .title{font-weight:700}
  .meta{font-size:12px;color:var(--muted);margin-top:6px}
  .toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .btn{border:1px solid #cfe3ff;background:#fff;color:#2563eb;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
  /* modal */
  .back{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .modal{background:#fff;border:1px solid #e6eefc;border-radius:16px;max-width:460px;width:100%;padding:18px}
  input[type="date"],input[type="text"]{padding:8px;border:1px solid #cfe3ff;border-radius:8px}
</style>
</head>
<body>
<header>
  <h3 style="margin:0">Call Follow-ups</h3>
  <span id="who" class="badge">Sign-in required</span>
  <span id="today" class="badge"></span>
  <div style="margin-left:auto" class="toolbar">
    <div id="gBtn"></div>
    <button class="btn" id="btnRefresh">Refresh</button>
    <button class="btn" id="btnClose">Force Close</button>
  </div>
</header>

<div class="container">
  <div class="card">
    <div class="toolbar">
      <span class="badge" id="count">0 items</span>
      <span id="countdown" style="color:#64748b"></span>
    </div>
    <div class="grid" id="grid"></div>
  </div>
</div>

<!-- Modal -->
<div class="back" id="mBack">
  <div class="modal">
    <h3 id="mTitle" style="margin:0 0 8px 0">Action</h3>
    <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
      <button class="btn primary" id="mDone">Done</button>
      <button class="btn" id="mUrgent">Urgent Follow-Up</button>
      <button class="btn" id="mCancel" style="margin-left:auto">Cancel</button>
    </div>
    <div id="urgent" style="display:none">
      <div style="display:flex;gap:10px;align-items:center;margin:8px 0">
        <label style="color:#64748b">Date:</label>
        <input type="date" id="fDate">
      </div>
      <div style="display:flex;gap:10px;align-items:center;margin:8px 0">
        <input type="text" id="fNote" placeholder="Note (optional)" style="flex:1">
        <button class="btn primary" id="mSchedule">Schedule</button>
      </div>
      <div id="hint" style="color:#64748b;font-size:12px"></div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG (REPLACE THIS) ======
  const API_URL   = 'https://script.google.com/macros/s/AKfycbwXj_bTIPzbZSa1u1NDHJDE15KbjW0zlqPq4QS1eq4LTUEWCGTvEOcHujDViGKLrb8k/exec';
  const CLIENT_ID = '360849757137-agopfs0m8rgmcj541ucpg22btep5olt3.apps.googleusercontent.com';

  // ====== STATE ======
  let idToken=null, userEmail=null, items=[], selected=null;

  // Google button:
  window.onload = () => {
    google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCred });
    google.accounts.id.renderButton(document.getElementById('gBtn'), { theme:'outline', size:'large', text:'continue_with' });
    document.getElementById('btnRefresh').onclick = load;
    document.getElementById('btnClose').onclick   = closeNow;
    startCountdown();
  };

  function handleCred(resp){
    idToken = resp.credential;
    try{
      const p = JSON.parse(atob(idToken.split('.')[1]));
      userEmail = p.email || '';
      document.getElementById('who').textContent = userEmail || 'Signed in';
    }catch{}
    load();
  }

  async function api(action, payload){
    const r = await fetch(API_URL, {
      method:'POST',
      body: JSON.stringify({action, idToken, payload})
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'API error');
    return j.data;
  }

  async function load(){
    if(!idToken) return alert('Please sign in.');
    const data = await api('getDashboard');
    userEmail = data.email;
    document.getElementById('who').textContent = userEmail;
    document.getElementById('today').textContent = 'Today: '+new Date().toISOString().slice(0,10);
    items = data.items || [];
    render();
  }

  function render(){
    const g = document.getElementById('grid'); g.innerHTML='';
    document.getElementById('count').textContent = items.length+' items';
    items.forEach((it,idx)=>{
      const d = document.createElement('div');
      d.className = 'chip'+(it.highlight?' follow':'');
      d.innerHTML = `<div class="title">${esc(it.party)}</div>
                     <div class="meta"><b>${it.source}</b>${it.dueDate ? ' â€¢ Due: '+fmt(it.dueDate):''}</div>`;
      d.onclick = ()=> openModal(it, idx);
      g.appendChild(d);
    });
  }

  function esc(s){return (''+s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));}
  function fmt(x){const d=new Date(x);return d.toLocaleDateString('en-IN',{day:'2-digit',month:'short',year:'numeric'});}

  // Modal
  function openModal(it, idx){
    selected = {it, idx};
    document.getElementById('mTitle').textContent = it.party;
    document.getElementById('urgent').style.display='none';
    document.getElementById('mBack').style.display='flex';
    document.getElementById('mDone').onclick = async ()=>{
      await api('markAction', {source:it.source,rowIndex:it.rowIndex,party:it.party,action:'Done'});
      items.splice(idx,1); closeModal(); render();
    };
    document.getElementById('mUrgent').onclick = showUrgent;
    document.getElementById('mCancel').onclick = closeModal;
  }
  function showUrgent(){
    const pane = document.getElementById('urgent'); pane.style.display='block';
    const f = document.getElementById('fDate');
    const hint = document.getElementById('hint');
    const today = new Date(); today.setHours(0,0,0,0);
    const max7 = new Date(today); max7.setDate(max7.getDate()+7);
    const sun = nextSunday(today);
    const cap = new Date(Math.min(max7,sun));
    f.min = iso(today); f.max = iso(cap);
    hint.textContent = `Select date till ${cap.toDateString()} (<=7 days and not beyond coming Sunday).`;
    document.getElementById('mSchedule').onclick = async ()=>{
      if(!f.value) return alert('Select date');
      const note = document.getElementById('fNote').value || '';
      await api('markAction',{source:selected.it.source,rowIndex:selected.it.rowIndex,party:selected.it.party,action:'UrgentFollowUp',followDateISO:f.value,note});
      closeModal();
    };
  }
  function closeModal(){ document.getElementById('mBack').style.display='none'; }
  function iso(d){ return d.toISOString().slice(0,10); }
  function nextSunday(d){ const delta=(7-d.getDay())%7; const x=new Date(d); x.setDate(x.getDate()+delta); x.setHours(23,59,59,999); return x; }

  // Force close
  async function closeNow(){
    if(!idToken) return alert('Sign in first.');
    if(!confirm('Mark remaining as Not-Done now?')) return;
    const res = await api('closeOutUser');
    alert('Auto-closed '+(res.closed||0)+' items.');
    load();
  }

  // Countdown (visual)
  function startCountdown(){
    const el = document.getElementById('countdown');
    function tick(){
      const now=new Date(); const tgt=new Date(); tgt.setHours(19,0,0,0);
      if(now>tgt){ el.textContent='Auto close done for today.'; return; }
      const ms=tgt-now; const h=Math.floor(ms/3600000), m=Math.floor(ms%3600000/60000), s=Math.floor(ms%60000/1000);
      el.textContent=`Auto close in ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
      setTimeout(tick,1000);
    } tick();
  }
</script>
</body>
</html>
